# Hands-on 2: provisioning

Hello, the goal here is to:
* provision a local Flatcar instance
* write Butane configuration
* generate the Ignition configuration
* boot the instance with the config

This is what we've done in the hands-1 but now it's done _as code_, we want to deploy an nginx container serving a "hello world" static webpage.

For this, there is an existing "config.yaml" (butane configuration), you need to write the content of /var/www/index.html (https://coreos.github.io/butane/examples/#files)

Hint: The Ignition configuration is a JSON file generated by Butane configuration. Butane (YAML) -> Ignition (JSON) -> Flatcar consumes this config.

# Step-by-step

* Open `./config.yaml` and find the TODO section.
* Add the following section (from https://coreos.github.io/butane/examples/#files):
```
storage:
  files:
    - path: /var/www/index.html
      contents:
        inline: Hello from FrOSCon 2023
```
* Transpile the Butane configuration (`config.yaml`) to Ignition configuration (`config.json`) - it's possible to use Butane binary (https://coreos.github.io/butane/getting-started/#standalone-binary) or Docker image
```
$ docker run --rm -i quay.io/coreos/butane:latest < config.yaml > config.json
```
* Download a Flatcar image (or reuse the zipped one from previous hands-on). NOTE: Ignition runs at first boot, it won't work if you reuse your previous boot image.
```
cp ../hands-on-1/flatcar/flatcar_production_qemu_image.img.bz2 .
bzip2 --decompress --keep ./flatcar_production_qemu_image.img.bz2
cp ../hands-on-1/flatcar/flatcar_production_qemu.sh .
```
* Start the image with Ignition configuration
```
./flatcar_production_qemu.sh -i ./config.json -- -display curses
```
* Once on the instance, assert nginx works correctly (`curl localhost` or `systemctl status nginx.service`)

# Resources

* https://coreos.github.io/butane/examples/
* https://coreos.github.io/ignition/rationale/
* https://www.flatcar.org/docs/latest/installing/#concepts-configuration-and-provisioning

# Demo

```
asciinema play demo.cast
```
or: https://asciinema.org/a/591440
